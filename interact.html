<html>
	<head>
		<title>FreshBooks API Playground</title>
		<link rel="stylesheet" href="css/reset.css" type="text/css" />
		<link rel="stylesheet" href="css/style.css" type="text/css" />
		<link rel="stylesheet" href="css/shCore.css" type="text/css" />
		<link rel="stylesheet" href="css/shThemeDefault.css" type="text/css" />
		<script type="text/javascript" src="js/jquery.js"></script>
		<script type="text/javascript" src="js/jquery.hotkeys-0.7.9.min.js"></script>
		<script type="text/javascript" src="js/shCore.js"></script>
		<script type="text/javascript" src="js/shBrushXml.js"></script>
		<script type="text/javascript" src="js/definition.json"></script>
		<script type="text/javascript">
			var newLine = '\r\n';
			var currentElementName = "";
			var currentElementMethods = "";
			var formerElementName = "";

			var currentMethodName = "";
			var formerMethodName = "";

			$(document).ready(function() {
				// Setup local storage
				if (!localStorage.isInitialized) {
					localStorage.isInitialized = true;
					resetData();
				} else {
					loadData();
				}

				// Look for verifiers
				var querystring = window.location.href.split("?");
				if (querystring.length > 1) {
					querystring = querystring[1].split("&");
					var token = "";
					var verifier = "";

					for (var i = 0; i < querystring.length; i++) {
						var keypair = querystring[i].split("=");
						if (keypair[0].toLowerCase() == "oauth_verifier") {
							verifier = keypair[1];
						}

						if (keypair[0].toLowerCase() == "oauth_token") {
							token = keypair[1];
						}
					}
					requestAccessToken(token, verifier);
				}

				SyntaxHighlighter.highlight();
				loadAuthPref();
				toggleOAuthConnect();
				toggleCurl();

				// Load up all the API Calls
				$.each(functions, function(key, val) {
					$('#functions').append('<li><a class="functions" href="#" alt="' + key + '">' + key + '</a></li>');
				});

				$('#sendRequest').click(function() {
					makeServerRequest();
					return false;
				});

				$('#curl').click(function() {
					if (localStorage.showcurl == "false") {
						localStorage.showcurl = "true";
					} else {
						localStorage.showcurl = "false";
					}

					toggleCurl();
					return false;
				});

				$('#switch').click(function() {
					if (localStorage.authPref == "token") {
						localStorage.authPref = "oauth";
					} else {
						localStorage.authPref = "token";
					}

					var code = createRequest();
					generateCurlCommand(code);
					loadAuthPref();
					return false;
				});

				$(document).bind('keydown', 'return', makeServerRequest);

				$('#connect').click(function() {
					getOAuthRequestToken();
				});
			});

			function downloadFile(url, xml, authorization, contentType) {
				var xhr = new XMLHttpRequest();
				xhr.open('POST', url, true);
				xhr.setRequestHeader('Authorization', authorization);
				xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded');
				xhr.responseType = 'arraybuffer';

				xhr.onload = function(e) {
					if (this.status == 200) {
						var bb = new window.WebKitBlobBuilder();
						bb.append(this.response);

						var blob = bb.getBlob(contentType);
						var blobURL = window.webkitURL.createObjectURL(blob);

						chrome.tabs.create({
								url:blobURL
						});
					}
					$('#loader').hide();
					displayCode('response', "Download complete!");
				};

				xhr.send(xml);
			}

			$('.authentication').live("keyup", function() {
				saveData();
				var code = createRequest();
				generateCurlCommand(code);
				toggleOAuthConnect();
			});

			// Capture the API Call selection
			$('a.functions').live("click", function() {
				formerElementName = currentElementName;
				currentMethodName = "";

				$('a.functions').removeClass("selected");
				$(this).addClass("selected");

				//Get the selected element
				currentElementName = $(this).attr("alt");
				currentElementMethods = functions[currentElementName];

				// Clear any methods/functions and add the new ones
				$('#methods').html("");
				$('#fields').html("");
				$.each(currentElementMethods, function(key, val) {
					$('#methods').append('<li><a class="methods" href="#" alt="' + key + '">' + key + '</a></li>');
				});

				return false;
			});

			// Capture the Method Selection
			$('a.methods').live("click", function() {
				var elementID = "";
				var elementIDValue = "";

				if (currentMethodName != 'create') {
					// extracttract the current id entered
					$('input.fields').each(function() {
						if ($(this).attr('alt').indexOf("_id") >= 0) {
							elementID = $(this).attr('alt');
							elementIDValue = $(this).val();
							return false;
						}
					});
				}

				$('a.methods').removeClass("selected");
				$(this).addClass("selected");

				formerMethodName = currentMethodName
				currentMethodName = $(this).attr("alt");

				//Extract the fields from the selected method
				$('#fields').html(exploreFields(currentElementMethods[currentMethodName], 0));

				$('#currentCurlCommand').html(currentElementName + '.' + currentMethodName);

				var code = createRequest();
				displayCode('request', code);
				generateCurlCommand(code);

				$('#fields input:first').focus();

				// Attempt to extract the newly created object id and auto-populate it anywhere its used
				if (formerMethodName == 'create') {
					var fieldName = "";
					var newID = "";

					$('#response code').each(function() {
						if ($(this).text().indexOf("_id") >= 0) {
							fieldName = $(this).text();
							newID = $(this).next().text();
							newID = newID.replace("<", "").replace(">", "").replace("/", "");
							return false;
						}
					});

					// Inject the id into the get parameter
					$('input.fields').each(function() {
						if ($(this).attr('alt') == fieldName) {
							$(this).val(newID);
						}
					});
				} else {
					// Inject the id into the get parameter
					$('input.fields').each(function() {
						if ($(this).attr('alt') == elementID) {
							$(this).val(elementIDValue);
						}
					});
					// Reset the values, so that it doesn't populate unknowingly
					elementID = "";
					elementIDValue = "";
				}

				return false;
			});

			// Capture the Method Selection
			$('a.duplicate').live("click", function() {
				parent = $(this).parent();
				copyElement = $(this).siblings('div')[0];

				$(parent).append(copyElement.outerHTML);

				return false;
			});

			// Update the curl command on every text change
			$('input.fields').live("keyup", function() {
				var code = createRequest();
				displayCode('request', code);
				generateCurlCommand(code);
			});

			// Recursively traverses the json object building the html form
			function exploreFields(root, level) {
				var fields = "";

				$.each(root, function(key, val) {
					if (typeof val == "object") {
						
						if (typeof key == "string" ) {
							fields += '<div class="fields" alt="' + key + '">';
							fields += '<h3>' + key + '</h3>';

							// Enable element duplication
							if (key == 'lines' || key == 'gateways' || key == 'contacts' || (key == 'staff' && level == 1) || key == 'tasks') {
								fields += '<a href="#" class="duplicate">Add more</a>';
							}
						}

						fields += exploreFields(val, level + 1);

						if (typeof key == "string" ) {
							fields +='</div>';
						}
					} else {
						fields += '<div class="fieldgroup"><label>' + val + '</label>';
						fields += '<input class="fields" type="text" alt="' + val + '"></input></div>';
					}
				});

				return fields;
			}

			// Builds the curl command
			function createRequest() {
				var command = "";

				if (currentElementName != "" && currentMethodName != "") {
					command += '<request method="' + currentElementName + '.' + currentMethodName + '">';
					command += parseFields($('#fields'), 1);
					command += newLine + '</request>';
				}

				return command;
			}

			// Traverses the parent element in the DOM until it reaches the bottom, to build the curl commands
			function parseFields(parent, level) {
				parent = parent[0];

				var xml = "";
				var tempParseResult = "";

				$.each($(parent).children(), function() {
					// fieldgroup divs contains the input
					if ($(this).hasClass("fieldgroup")) {
						var input = $("input", this)[0];
						if ($(input).val() != "") {
							xml += newLine + tabs(level) + '<' + $(input).attr("alt") + '>';
							xml += $(input).val();
							xml += '</' + $(input).attr("alt") + '>';
						}
					// All other divs contains a subgrouping
					} else if ($(this).is("div")) {
						tempParseResult = parseFields($(this), level + 1);

						if (tempParseResult != "") {
							xml += newLine + tabs(level) + '<' + $(this).attr("alt") + '>';
							xml += '' + tempParseResult;
							xml += newLine + tabs(level) + '</' + $(this).attr("alt") + '>';
						}
					}
				});

				return xml;
			}

			function tabs(count) {
				var tabs = "";
				for (var i = 0; i < count; i++) {
					tabs += '\t';
				}

				return tabs;
			}

			function makeServerRequest() {
				var apiURL = getResourceURL();
				var xmlRequest = createRequest();

				if (apiURL == "") {
					displayCode('response', "You have to provide a subdomain");
					return;
				}

				if (xmlRequest == "") {
					displayCode('response', "You have to select a call and method");
					return;
				}

				var authorization = "";

				// Validate requests
				if (isTokenAuth()) {
					var apiToken = getToken();

					if (apiToken == "") {
						displayCode('response', "You have to provide a token");
						return;
					}
					authorization = make_base_auth(apiToken, 'X');
				} else {
					var consumerKey = getConsumerKey();
					var consumerKeySecret = getConsumerKeySecret();
					var accessToken = getAccessToken();
					var accessTokenSecret = getAccessTokenSecret();

					if (consumerKey == "") {
						displayCode('response', "You have to provide a consumer key");
						return;
					}

					if (accessToken == "") {
						displayCode('response', "You have to provide an access token");
						return;
					}

					if (accessTokenSecret == "") {
						displayCode('response', "You have to provide an access token secret");
						return;
					}
					authorization = getOAuthHeader(consumerKey, consumerKeySecret, accessToken, accessTokenSecret);
				}

				$('#response').hide();
				$('#loader').show();

				if (currentMethodName.toLowerCase() == 'getpdf') {
					downloadFile(apiURL, xmlRequest, authorization, 'application/pdf');
					displayCode('response', 'PDF Downloading..');
				} else if (currentElementName == 'receipt' && currentMethodName == 'get') {
					downloadFile(apiURL, xmlRequest, authorization, 'image/xyz');
					displayCode('response', 'Image Downloading..');
				} else if (currentElementName == 'receipt' && (currentMethodName == 'create' || currentMethodName == 'update')) {
					uploadFile(apiURL, xmlRequest, authorization);
				} else {
					$.ajax({
						type: "POST",
						url: apiURL,
						async: true,
						data: xmlRequest,
						headers: {
									'FB-User-Agent': "FreshBooks API Playground",
									'Authorization': authorization,
									'content-type': 'application/x-www-form-urlencoded'
								 },
						dataType: "arraybuffer",
						complete: function(xhr, status) {
							$('#loader').hide();
							if (status != 'error') {
								displayCode('response', xhr.responseText);
							} else {

							}

						},
						error: function() {
							$('#loader').hide();
							displayCode('response', "Unable to connect to server");
						}
					});
				}
			}

			function getOAuthRequestToken() {
				var url = getRequestTokenURI();
				var consumerKey = getConsumerKey();
				var consumerKeySecret = getConsumerKeySecret();

				if (consumerKey == "") {
					displayCode('response', "You have to provide a consumer key");
					return;
				}

				if (url == "") {
					displayCode('response', "You have to provide a subdomain");
					return;
				}

				$.ajax({
					type: "POST",
					url: getRequestTokenURI(),
					async: true,
					dataType: "xml",
					headers: {
								'FB-User-Agent': "FreshBooks API Playground",
								'Authorization': getOAuthHeader(consumerKey, consumerKeySecret, "", "", getExtensionURL(), ""),
								'content-type': 'application/x-www-form-urlencoded'
							 },
					complete: function(xhr, status) {
						// search for oauth_token
						var parameters = xhr.responseText.split("&");
						for (var i = 0; i < parameters.length; i++) {
							var keypair = parameters[i].split("=");
							if (keypair[0].toLowerCase() == "oauth_token") {
								chrome.tabs.create({
										url:getAuthorizeTokenURI(keypair[1])
								});

								chrome.tabs.getCurrent(function(tab) {
									chrome.tabs.remove(tab.id);
								});
							}
						}
					},
					error: function(xhr) {
						displayCode('response', xhr.responseText);
					}
				});
			}

			function requestAccessToken(token, verifier) {
				var consumerKey = getConsumerKey();
				var consumerKeySecret = getConsumerKeySecret();

				if (consumerKey == "") {
					displayCode('response', "You have to provide a consumer key");
					return;
				}

				if (consumerKeySecret == "") {
					displayCode('response', "You have to provide a consumer key secret");
					return;
				}

				$('#response').hide();

				$.ajax({
					type: "POST",
					url: getAccessTokenURI(),
					async: true,
					dataType: "xml",
					headers: {
								'FB-User-Agent': "FreshBooks API Playground",
								'Authorization': getOAuthHeader(consumerKey, consumerKeySecret, token, "", getExtensionURL(), verifier),
								'content-type': 'application/x-www-form-urlencoded'
							 },
					complete: function(xhr, status) {
						// search for access_token and access_token_secret
						var parameters = xhr.responseText.split("&");
						for (var i = 0; i < parameters.length; i++) {
							var keypair = parameters[i].split("=");
							if (keypair[0].toLowerCase() == "oauth_token") {
								localStorage.accesstoken = keypair[1];
							}

							if (keypair[0].toLowerCase() == "oauth_token_secret") {
								localStorage.accesstokensecret = keypair[1];
							}
						}
						loadData();
						window.location = getExtensionURL();
					},
					error: function(xhr) {
						displayCode('response', xhr.responseText);
					}
				});
			}

			function getOAuthHeader(consumer, consumersecret, token, tokensecret, callback, verifier) {

				var header = 'OAuth realm="",oauth_version="1.0",oauth_consumer_key="' + consumer +'",oauth_timestamp="'+ getTimestamp() +'",oauth_nonce="'+ getNonce() +'",oauth_signature_method="PLAINTEXT"';

				// Add the consumer secret and access token secret
				header += ',oauth_signature="' + consumersecret + '%2526';
				if (tokensecret != "") {
					header += tokensecret;
				}
				header += '"';

				// Adding the token
				if (token != "") {
					header += ',oauth_token="'+ token + '"';
				}

				// Callback for getting a request token
				if (callback != "") {
					header += ',oauth_callback="'+ callback + '"';
				}

				// Verifier for getting access tokens
				if (verifier != "") {
					header += ',oauth_verifier="'+ verifier + '"';
				}

				return header;
			}

			function generateCurlCommand(code) {
				var apiURL = getResourceURL();

				if (code != "" && apiURL != "") {
					if (isTokenAuth()) {
						var apiToken = getToken();
						if (apiToken != "") {
							var command = "curl -k -u " + apiToken + ":X " + apiURL + " -d '" + code.replace(/[\n\r\t]/g, '') + "'";
							$('#curlCommand').html(command);
						}
					} else {
						var consumerkey = getConsumerKey();
						var consumersecret = getConsumerKeySecret();
						var accesstoken = getAccessToken();
						var accesstokensecret = getAccessTokenSecret();

						if (consumerkey != "" && consumersecret != "" && accesstoken != "" && accesstokensecret != "") {
							var command = "curl -k -H 'Authorization : " + getOAuthHeader(consumerkey, consumersecret, accesstoken, accesstokensecret, "", "") + "' " + apiURL + " -d '" + code.replace(/[\n\r\t]/g, '') + "'";
							$('#curlCommand').html(command);
						}
					}
				}
			}

			function displayCode(sectionID, code) {
				var sectionJQ = "#" + sectionID;
				var parent = $(sectionJQ).parent();

				$(sectionJQ).remove();
				$(parent).append('<pre id="' + sectionID + '" class="brush: xml; toolbar: false; auto-links:false;"></pre>');
				$(sectionJQ).append(code);

				SyntaxHighlighter.highlight();
			}

			function make_base_auth(user, password) {
				var tok = user + ':' + password;
				var hash = window.btoa(tok);
				return "Basic " + hash;
			}

			function loadAuthPref() {
				if (localStorage.authPref == "token") {
					$('#authTitle').text("Token User");
					$('#oauthCredentials').hide();
					$('#tokenCredentials').show();
				} else {
					$('#authTitle').text("OAuth User");
					$('#oauthCredentials').show();
					$('#tokenCredentials').hide();
				}
			}

			function toggleOAuthConnect() {
				if (getAccessToken() == "" && getAccessTokenSecret() == "") {
					$('#connect').show();
				} else {
					$('#connect').hide();
				}
			}

			function toggleCurl() {
				if (localStorage.showcurl == "false") {
					$('#curl').text("Show Curl Request");
					$('#curlCommand').hide();
				} else {
					$('#curl').text("Hide Curl Request");
					$('#curlCommand').show();
				}
			}

			function isTokenAuth() {
				return localStorage.authPref == "token";
			}

			function resetData() {
				localStorage.showcurl = "false";
				localStorage.authPref = "token";
				localStorage.subdomain = "";
				localStorage.apikey = "";
				localStorage.consumerkey = "";
				localStorage.consumersecret = "";
				localStorage.accesstoken = "";
				localStorage.accesstokensecret = "";
			}

			function saveData() {
				var url = $('#apiURL').val().trim();
				var hostname = url.match("(https|http)?(://)?([a-zA-Z0-9\.]*)?(/.*)?");

				// Only save if we find a subdomain value
				if (hostname[3]) {
					// If only a subdomain is provided, we automatically append '.freshbooks.com'
					subdomain = hostname[3];
					if (subdomain.indexOf(".") < 0) {
						subdomain = subdomain + ".freshbooks.com";
					}
					localStorage.subdomain = subdomain;
				} else {
					localStorage.subdomain = "";
				}

				localStorage.apikey = $('#apiToken').val().trim();
				localStorage.consumerkey = $('#consumerKey').val().trim();
				localStorage.consumersecret = $('#consumerSecret').val().trim();
				localStorage.accesstoken = $('#accessToken').val().trim();
				localStorage.accesstokensecret = $('#accessTokenSecret').val().trim();
			}

			function loadData() {
				$('#apiURL').val(localStorage.subdomain);
				$('#apiToken').val(localStorage.apikey);
				$('#consumerKey').val(localStorage.consumerkey);
				$('#consumerSecret').val(localStorage.consumersecret);
				$('#accessToken').val(localStorage.accesstoken);
				$('#accessTokenSecret').val(localStorage.accesstokensecret);
			}

			function getConsumerKey() {
				return localStorage.consumerkey;
			}

			function getConsumerKeySecret() {
				return localStorage.consumersecret;
			}

			function getAccessToken() {
				return localStorage.accesstoken;
			}

			function getAccessTokenSecret() {
				return localStorage.accesstokensecret;
			}

			function getSubdomain() {
				return localStorage.subdomain;
			}

			function getExtensionURL() {
				var url = document.URL.split("?");
				url = url[0];
				return url.replace("#", "");
			}

			function getResourceURL() {
				var subdomain = getSubdomain();
				if (subdomain != "") {
					subdomain = 'https://' + subdomain + '/api/2.1/xml-in';
				}

				return subdomain
			}

			function getRequestTokenURI() {
				var subdomain = getSubdomain();
				if (subdomain != "") {
					subdomain = 'https://' + subdomain + '/oauth/oauth_request.php';
				}

				return subdomain
			}

			function getAuthorizeTokenURI(token) {
				var subdomain = getSubdomain();
				if (subdomain != "") {
					subdomain = 'https://' + subdomain + '/oauth/oauth_authorize.php?oauth_token=' + token;
				}

				return subdomain
			}

			function getAccessTokenURI() {
				var subdomain = getSubdomain();
				if (subdomain != "") {
					subdomain = 'https://' + subdomain + '/oauth/oauth_access.php';
				}

				return subdomain
			}

			function getToken() {
				return localStorage.apikey;
			}

			// From Netflix's oauth implementation
			function getTimestamp() {
				var t = (new Date()).getTime();
				return Math.floor(t / 1000);
			}

			// From Netflix's oauth implementation
			function getNonce() {
				var nonceLength = 15;
				var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
				var result = "";
				for (var i = 0; i < nonceLength; ++i) {
				var rnum = Math.floor(Math.random() * chars.length);
					result += chars.substring(rnum, rnum+1);
				}
				return result;
			}
		</script>
	</head>
	<body>
		<h1>FreshBooks API Playground</h1>

		<div id="sidebar">
			<div class="input_grouping">
				<h2>1) Select an API Call</h2>
				<hr/>
				<ul id="functions"></ul>
				<div class="clearfix"></div>
			</div>
			

			<div class="input_grouping">
				<h2>2) Choose a Method To Run</h2>
				<hr/>
				<ul id="methods"></ul>
				<div class="clearfix"></div>
			</div>

			<div class="input_grouping">
				<h2>3) Fill in your Fields</h2>
				<hr/>
				<div id="fields" class="fields"></div>
				<div class="clearfix"></div>
			</div>
		</div>

		<div id="content">
			<div id="userDetails" class="requestInfo input_grouping">
				<h2><span id="authTitle">Token User</span> <a href="#" id="switch">Switch</a></h2>
				<hr/>
				<p><input id="apiURL" placeholder="subdomain.freshbooks.com" type="text" name="apiURL" class="authentication"/></p>

				<div id="tokenCredentials">
					<input id="apiToken" placeholder="API Token" type="text" name="apiToken" class="authentication"/>
				</div>

				<div id="oauthCredentials">
					<input id="consumerKey" placeholder="Consumer Key" type="text" name="consumerKey" class="authentication"/>
					<input id="consumerSecret" placeholder="Consumer Secret" type="text" name="consumerSecret" class="authentication"/>
					<input id="accessToken" placeholder="Access Token" type="text" name="accessToken" class="authentication"/>
					<input id="accessTokenSecret" placeholder="Access Token Secret" type="text" name="accessTokenSecret" class="authentication"/>
					<a href="#" id="connect">No access token? Connect your account.</a>
				</div>
			</div>

			<div class="requestInfo input_grouping">
				<h2>Request <a href="#" id="curl">Show Curl Request</a></h2>
				<hr/>
				<textarea id="curlCommand" rows="1" wrap="off"></textarea>
				<div>
					<pre id="request" class="brush: xml; toolbar: false; auto-links:false;"></pre>
				</div>
				<a href="#" id="sendRequest" accesskey="S">Send Request</a>
			</div>

			<div class="requestInfo input_grouping">
				<h2>Response</h2>
				<hr/>
				<div id="loader">
					<img src="media/ajax-loader.gif"/><br/>
					<p>Shhh! I&apos;m thinking!</p>
				</div>
				<pre id="response" class="brush: xml; toolbar: false; auto-links:false;"></pre>
			</div>
		</div>
	</body>
</html>